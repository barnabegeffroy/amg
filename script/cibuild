set -e
DEPLOY_REPO="https://${MY_WEBSITE}@github.com/barnabegeffroy/amg.git"
function main {
	clean
	# get_current_site
	build_site
	deploy
}

function clean { 
	echo "cleaning _site folder"
	if [ -d "_site" ]; then rm -Rf _site; fi 
}

function get_current_site { 
	echo "getting latest site"
	git clone --depth 1 $DEPLOY_REPO _site 
}

function build_site { 
	echo "building site"
	bundle exec jekyll build --trace
}

function deploy {
	echo "deploying changes"

	if [ -z "$TRAVIS_PULL_REQUEST" ]; then
	    echo "except don't publish site for pull requests"
	    exit 0
	fi  

	if [ "$TRAVIS_BRANCH" != "build" ]; then
	    echo "except we should only publish the build branch. stopping here"
	    exit 0
	fi

	git config git-ftp.url "amg-coach.fr"
	git config git-ftp.user "wm95f_amg"
	git config git-ftp.password $PASSWORD
	git ftp catchup
	git add _site/*
	git status
	git commit -m "Lastest site built on successful travis build $TRAVIS_BUILD_NUMBER auto-pushed to ftp"
	git ftp push



}

main
